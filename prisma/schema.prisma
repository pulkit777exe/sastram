generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                      String                   @id @default(cuid())
  email                   String                   @unique
  emailVerified           Boolean                  @default(false)
  name                    String?
  image                   String?
  bio                     String?
  location                String?
  website                 String?
  twitter                 String?
  github                  String?
  linkedin                String?
  avatarUrl               String?
  bannerUrl               String?
  preferences             Json?                    @default("{}")
  status                  UserStatus               @default(ACTIVE)
  role                    Role                     @default(USER)
  lastSeenAt              DateTime?
  profilePrivacy          ProfilePrivacy           @default(PUBLIC)
  reputationPoints        Int                      @default(0)
  followerCount           Int                      @default(0)
  followingCount          Int                      @default(0)
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  deletedAt               DateTime?
  
  // Relations
  accounts                Account[]
  sessions                Session[]
  communities             Community[]              @relation("CommunityCreator")
  sections                Section[]                @relation("SectionCreator")
  messages                Message[]
  reactions               Reaction[]
  sectionMemberships      SectionMember[]
  readReceipts            ReadReceipt[]
  notifications           Notification[]
  notificationSettings    NotificationSettings[]
  newsletterSubscriptions NewsletterSubscription[]
  reports                 Report[]                 @relation("ReportReporter")
  reportedMessages        Report[]                 @relation("ReportedMessage")
  sentInvitations         ThreadInvitation[]       @relation("InvitationSender")
  bans                    UserBan[]                @relation("BannedUser")
  issuedBans              UserBan[]                @relation("BanIssuer")
  auditLogs               AuditLog[]               @relation("AuditLogUser")
  performedActions        AuditLog[]               @relation("AuditLogPerformer")
  followers               UserFollow[]             @relation("Follower")
  following               UserFollow[]             @relation("Following")
  bookmarks               UserBookmark[]
  reputation              UserReputation?
  earnedBadges            UserBadgeEarned[]
  activities              UserActivity[]
  pollVotes               PollVote[]

  @@index([email])
  @@index([status])
  @@index([lastSeenAt])
  @@map("users")
}

model Community {
  id          String    @id @default(cuid())
  title       String
  slug        String    @unique
  description String?
  visibility  CommunityVisibility @default(PUBLIC)
  settings    Json?     @default("{}")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  createdBy   String
  
  creator     User      @relation("CommunityCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  sections    Section[]

  @@index([slug])
  @@index([visibility])
  @@map("communities")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  expiresAt DateTime
  token     String   @unique
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("sessions")
}

model Account {
  id           String    @id @default(cuid())
  accountId    String    @unique
  providerId   String
  userId       String
  accessToken  String?
  refreshToken String?
  idToken      String?
  expiresAt    DateTime?
  password     String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
  @@map("accounts")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, value])
  @@map("verifications")
}

model Section {
  id                      String                   @id @default(cuid())
  name                    String
  slug                    String                   @unique
  description             String?
  summary                 String?
  icon                    String?
  visibility              SectionVisibility        @default(PUBLIC)
  settings                Json?                    @default("{}")
  messageCount            Int                      @default(0)
  memberCount             Int                      @default(0)
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  deletedAt               DateTime?
  createdBy               String
  communityId             String?
  
  // Relations
  creator                 User                     @relation("SectionCreator", fields: [createdBy], references: [id])
  community               Community?               @relation(fields: [communityId], references: [id])
  messages                Message[]
  members                 SectionMember[]
  readReceipts            ReadReceipt[]
  newsletterSubscriptions NewsletterSubscription[]
  digests                 ThreadDigest[]
  invitations             ThreadInvitation[]
  bans                    UserBan[]                @relation("ThreadBans")
  bookmarks               UserBookmark[]
  tags                    ThreadTagRelation[]
  poll                    Poll?

  @@index([slug])
  @@index([visibility])
  @@index([communityId])
  @@index([createdBy])
  @@map("sections")
}

model SectionMember {
  id        String           @id @default(cuid())
  sectionId String
  userId    String
  role      SectionRole      @default(MEMBER)
  status    MemberStatus     @default(ACTIVE)
  joinedAt  DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  
  section   Section          @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sectionId, userId])
  @@index([sectionId])
  @@index([userId])
  @@index([role])
  @@map("section_members")
}

model Message {
  id          String       @id @default(cuid())
  content     String       @db.Text
  sectionId   String
  senderId    String
  parentId    String?
  depth       Int          @default(0)
  isEdited    Boolean      @default(false)
  isPinned    Boolean      @default(false)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?
  
  // Relations
  section     Section      @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  sender      User         @relation(fields: [senderId], references: [id], onDelete: Cascade)
  parent      Message?     @relation("MessageReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     Message[]    @relation("MessageReplies")
  attachments Attachment[]
  reactions   Reaction[]
  readReceipts ReadReceipt[]
  reports     Report[]
  editHistory MessageEdit[]
  mentions    MessageMention[]

  @@index([sectionId])
  @@index([senderId])
  @@index([parentId])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("messages")
}

model MessageEdit {
  id          String   @id @default(cuid())
  messageId   String
  content     String   @db.Text
  editedAt    DateTime @default(now())
  
  message     Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@map("message_edits")
}

model MessageMention {
  id          String   @id @default(cuid())
  messageId   String
  userId      String
  createdAt   DateTime @default(now())
  
  message     Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([userId])
  @@map("message_mentions")
}

model Attachment {
  id        String         @id @default(cuid())
  messageId String
  url       String
  type      AttachmentType
  name      String?
  mimeType  String?
  size      BigInt?
  createdAt DateTime       @default(now())
  
  message   Message        @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@map("attachments")
}

model Reaction {
  id        String   @id @default(cuid())
  messageId String
  userId    String
  emoji     String
  createdAt DateTime @default(now())
  
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@index([userId])
  @@map("reactions")
}

model ReadReceipt {
  id           String   @id @default(cuid())
  sectionId    String
  userId       String
  lastReadMessageId String?
  lastReadAt   DateTime @default(now())
  
  section      Section  @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lastMessage  Message? @relation(fields: [lastReadMessageId], references: [id], onDelete: SetNull)

  @@unique([sectionId, userId])
  @@index([userId])
  @@index([lastReadAt])
  @@map("read_receipts")
}

model Notification {
  id          String            @id @default(cuid())
  userId      String
  type        NotificationType
  title       String
  message     String?
  data        Json?
  isRead      Boolean           @default(false)
  createdAt   DateTime          @default(now())
  readAt      DateTime?
  
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model NotificationSettings {
  id                String   @id @default(cuid())
  userId            String
  sectionId         String?
  emailEnabled      Boolean  @default(true)
  pushEnabled       Boolean  @default(true)
  mentionsEnabled   Boolean  @default(true)
  repliesEnabled    Boolean  @default(true)
  digestEnabled     Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, sectionId])
  @@index([userId])
  @@map("notification_settings")
}

model NewsletterSubscription {
  id        String   @id @default(cuid())
  threadId  String
  userId    String?
  email     String
  frequency DigestFrequency @default(WEEKLY)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  thread    Section  @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id])

  @@unique([threadId, email])
  @@index([threadId])
  @@index([userId])
  @@map("newsletter_subscriptions")
}

model ThreadDigest {
  id           String       @id @default(cuid())
  threadId     String
  scheduledFor DateTime
  processedAt  DateTime?
  status       DigestStatus @default(PENDING)
  summary      String?      @db.Text
  emailCount   Int          @default(0)
  createdAt    DateTime     @default(now())
  
  thread       Section      @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@unique([threadId, scheduledFor])
  @@index([status])
  @@index([scheduledFor])
  @@map("thread_digests")
}

model Report {
  id         String       @id @default(cuid())
  messageId  String
  reporterId String
  reason     String
  details    String?      @db.Text
  status     ReportStatus @default(PENDING)
  resolvedBy String?
  resolvedAt DateTime?
  resolution String?      @db.Text
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  
  message    Message      @relation(fields: [messageId], references: [id], onDelete: Cascade)
  reporter   User         @relation("ReportReporter", fields: [reporterId], references: [id], onDelete: Cascade)
  resolver   User?        @relation("ReportedMessage", fields: [resolvedBy], references: [id])

  @@index([messageId])
  @@index([reporterId])
  @@index([status])
  @@map("reports")
}

model ThreadInvitation {
  id        String           @id @default(cuid())
  threadId  String
  senderId  String
  email     String
  message   String?          @db.Text
  status    InvitationStatus @default(PENDING)
  token     String?          @unique
  expiresAt DateTime?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  
  thread    Section          @relation(fields: [threadId], references: [id], onDelete: Cascade)
  sender    User             @relation("InvitationSender", fields: [senderId], references: [id], onDelete: Cascade)

  @@unique([threadId, email, senderId])
  @@index([threadId])
  @@index([senderId])
  @@index([status])
  @@index([token])
  @@map("thread_invitations")
}

model UserBan {
  id           String    @id @default(cuid())
  userId       String
  bannedBy     String
  reason       String
  customReason String?   @db.Text
  threadId     String?
  isActive     Boolean   @default(true)
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  user         User      @relation("BannedUser", fields: [userId], references: [id], onDelete: Cascade)
  issuer       User      @relation("BanIssuer", fields: [bannedBy], references: [id], onDelete: Cascade)
  thread       Section?  @relation("ThreadBans", fields: [threadId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([bannedBy])
  @@index([threadId])
  @@index([expiresAt])
  @@index([isActive])
  @@map("user_bans")
}

model AuditLog {
  id           String      @id @default(cuid())
  action       AuditAction
  entityType   String
  entityId     String
  userId       String?
  performedBy  String?
  details      Json?
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime    @default(now())
  
  user         User?       @relation("AuditLogUser", fields: [userId], references: [id])
  performer    User?       @relation("AuditLogPerformer", fields: [performedBy], references: [id])

  @@index([action])
  @@index([entityType])
  @@index([entityId])
  @@index([userId])
  @@index([performedBy])
  @@index([createdAt])
  @@map("audit_logs")
}

// Enums
enum Role {
  USER
  MODERATOR
  ADMIN
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  BANNED
  DELETED
}

enum CommunityVisibility {
  PUBLIC
  PRIVATE
  UNLISTED
}

enum SectionVisibility {
  PUBLIC
  PRIVATE
  RESTRICTED
}

enum SectionRole {
  OWNER
  MODERATOR
  MEMBER
  VIEWER
}

enum MemberStatus {
  ACTIVE
  INVITED
  LEFT
  REMOVED
}

enum AttachmentType {
  IMAGE
  GIF
  VIDEO
  FILE
  AUDIO
}

enum DigestStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
}

enum DigestFrequency {
  DAILY
  WEEKLY
  MONTHLY
}

enum ReportStatus {
  PENDING
  REVIEWING
  RESOLVED
  DISMISSED
}

enum InvitationStatus {
  PENDING
  SENT
  ACCEPTED
  DECLINED
  EXPIRED
}

enum NotificationType {
  MESSAGE
  REPLY
  MENTION
  REACTION
  INVITATION
  DIGEST
  REPORT
  BAN
  SYSTEM
}

enum AuditAction {
  USER_CREATED
  USER_UPDATED
  USER_DELETED
  USER_BANNED
  USER_UNBANNED
  MESSAGE_CREATED
  MESSAGE_UPDATED
  MESSAGE_DELETED
  SECTION_CREATED
  SECTION_UPDATED
  SECTION_DELETED
  MEMBER_ADDED
  MEMBER_REMOVED
  MEMBER_ROLE_CHANGED
  REPORT_CREATED
  REPORT_RESOLVED
}

enum ProfilePrivacy {
  PUBLIC
  PRIVATE
  FOLLOWERS_ONLY
}

// User Follow System
model UserFollow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())
  
  follower    User     @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("user_follows")
}

// Bookmarks System
model UserBookmark {
  id        String   @id @default(cuid())
  userId    String
  threadId  String
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  thread    Section  @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@unique([userId, threadId])
  @@index([userId])
  @@index([threadId])
  @@map("user_bookmarks")
}

// Tags System
model ThreadTag {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  color     String   @default("#3b82f6")
  createdAt DateTime @default(now())
  
  threads   ThreadTagRelation[]

  @@index([slug])
  @@map("thread_tags")
}

model ThreadTagRelation {
  id        String   @id @default(cuid())
  threadId  String
  tagId     String
  createdAt DateTime @default(now())
  
  thread    Section  @relation(fields: [threadId], references: [id], onDelete: Cascade)
  tag       ThreadTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([threadId, tagId])
  @@index([threadId])
  @@index([tagId])
  @@map("thread_tag_relations")
}

// Polls System
model Poll {
  id        String   @id @default(cuid())
  threadId  String   @unique
  question  String
  options   Json     // Array of option strings
  isActive  Boolean  @default(true)
  expiresAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  thread    Section  @relation(fields: [threadId], references: [id], onDelete: Cascade)
  votes     PollVote[]

  @@index([threadId])
  @@index([isActive])
  @@map("polls")
}

model PollVote {
  id          String   @id @default(cuid())
  pollId      String
  userId      String
  optionIndex Int
  createdAt   DateTime @default(now())
  
  poll        Poll     @relation(fields: [pollId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([pollId, userId])
  @@index([pollId])
  @@index([userId])
  @@map("poll_votes")
}

// Reputation System
model UserReputation {
  id        String   @id @default(cuid())
  userId    String   @unique
  points    Int      @default(0)
  level     Int      @default(1)
  updatedAt DateTime @updatedAt
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([points])
  @@index([level])
  @@map("user_reputation")
}

// Badges System
model UserBadge {
  id          String   @id @default(cuid())
  name        String   @unique
  description String
  icon        String?
  color       String   @default("#3b82f6")
  criteria    Json     // Criteria for earning badge
  createdAt   DateTime @default(now())
  
  earnedBy    UserBadgeEarned[]

  @@index([name])
  @@map("user_badges")
}

model UserBadgeEarned {
  id        String   @id @default(cuid())
  userId    String
  badgeId   String
  earnedAt  DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge     UserBadge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
  @@index([badgeId])
  @@map("user_badges_earned")
}

// Activity Feed System
model UserActivity {
  id         String   @id @default(cuid())
  userId     String
  type       String   // THREAD_CREATED, MESSAGE_POSTED, BOOKMARK_ADDED, etc.
  entityType String   // Section, Message, User, etc.
  entityId   String
  metadata   Json?
  createdAt  DateTime @default(now())
  
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@index([entityType, entityId])
  @@map("user_activities")
}